name: {{jobs.name.titleCase()}} Verify and Test
{{=<% %>=}}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
<%={{ }}=%>
on:
  pull_request:
    branches:
      - master
      - main
    paths:
      - ".github/workflows/{{{jobs.name}}}_verify_and_test.yaml"
      - "{{{jobs.globPath}}}"
{{{jobs.dependenciesDirs}}}
  push:
    branches:
      - master
      - main
    paths:
      - ".github/workflows/**"
      - "{{{jobs.globPath}}}"
{{{jobs.dependenciesDirs}}}

jobs:
  {{mainJobName}}:
    name: Verify and Test
    defaults:
      run:
        working-directory: {{{jobs.packageDir}}}

    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v6

      {{#jobs.usesFlutter}}- name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: {{{flutterVersion}}}
          channel: {{{flutterChannel}}}
          cache: true
          cache-key: flutter-:os:-:channel:-:version:-:arch:-:hash:-{{=<% %>=}}${{ hashFiles('**/pubspec.lock') }}<%={{ }}=%>

      - name: ğŸ“¦ Install Dependencies
        run: |
          flutter pub global activate very_good_cli
          very_good packages get --recursive --ignore=!*{{/jobs.usesFlutter}}{{^jobs.usesFlutter}}- name: ğŸ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: {{{dartChannel}}}

      - name: ğŸ“¦ Install Dependencies
        run: dart pub get{{/jobs.usesFlutter}}

      - name: âœ¨ Check Formatting
        run: dart format --set-exit-if-changed {{jobs.formatDirectories}}
      
      - name: ğŸ•µï¸ Analyze
        {{#jobs.usesFlutter}}run: flutter analyze {{jobs.analyzeDirectories}}{{/jobs.usesFlutter}}{{^jobs.usesFlutter}}run: dart analyze --fatal-infos --fatal-warnings {{jobs.analyzeDirectories}}{{/jobs.usesFlutter}}{{#jobs.runBlocLint}}

      - name: âœ… Bloc Lint
        run: |
          {{#jobs.usesFlutter}}flutter pub global activate bloc_tools{{/jobs.usesFlutter}}{{^jobs.usesFlutter}}dart pub global activate bloc_tools{{/jobs.usesFlutter}}
          bloc lint .{{/jobs.runBlocLint}}{{#jobs.runTests}}

      - name: ğŸ§ª Run Tests
        run: {{#jobs.usesFlutter}}very_good test -j 4 --optimization --coverage --test-randomize-ordering-seed random{{/jobs.usesFlutter}}{{^jobs.usesFlutter}}|
          dart pub global activate coverage 1.15.0
          dart test -j 4 --coverage=coverage --platform=vm && dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on={{jobs.reportOnDirectories}}{{/jobs.usesFlutter}}{{#jobs.hasMinimumCoverage}}

      - name: ğŸ“Š Check Code Coverage
        uses: VeryGoodOpenSource/very_good_coverage@v3
        with:
          path: {{{jobs.packageDir}}}/coverage/lcov.info{{#jobs.hasCoverageExcludes}}
          exclude: "{{{jobs.coverageExclude}}}"{{/jobs.hasCoverageExcludes}}
          min_coverage: {{jobs.minCoverage}}{{/jobs.hasMinimumCoverage}}{{/jobs.runTests}}{{#jobs.checkLicenses}}

  {{licenseCheckJobName}}:
    name: License Check
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/license_check.yml@v1
    with:
      working_directory: {{{jobs.packageDir}}}{{/jobs.checkLicenses}}